<template>
  <div class="contentBlock mb-5">
    <div class="f-24 fw-600 mb-3">
      Обзор
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div class="col-12  mb-20">
          <div class="b-radius bg-white p-3">
            <div class="d-flex align-items-center flex-wrap justify-content-between mb-3">
              <div class="f-18 fw-600">
                Отчеты по рекламе
              </div>
              <div class="blockHeaderButton">
                <svg width="14" height="4" viewBox="0 0 14 4" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g opacity="0.3">
                    <path d="M13.4874 0.512567C12.804 -0.170848 11.696 -0.170848 11.0126 0.512567C10.3291 1.19598 10.3291 2.30402 11.0126 2.98744C11.696 3.67085 12.804 3.67085 13.4874 2.98744C14.1709 2.30405 14.1709 1.19601 13.4874 0.512567Z" fill="#030229"/>
                    <path d="M8.23744 0.512567C7.55402 -0.170848 6.44598 -0.170848 5.76257 0.512567C5.07915 1.19598 5.07915 2.30402 5.76257 2.98744C6.44598 3.67085 7.55402 3.67085 8.23744 2.98744C8.92085 2.30405 8.92085 1.19601 8.23744 0.512567Z" fill="#030229"/>
                    <path d="M2.98744 0.512567C2.30402 -0.170848 1.19598 -0.170848 0.512564 0.512567C-0.170852 1.19598 -0.170852 2.30402 0.512564 2.98744C1.19598 3.67085 2.30402 3.67085 2.98744 2.98744C3.67085 2.30405 3.67085 1.19601 2.98744 0.512567Z" fill="#030229"/>
                  </g>
                </svg>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-6 pr-2 pl-2 mb-3">
                <div class="border p-2 b-radius d-flex flex-column align-items-center justify-content-center">
                  <div class="f-14 color-1 mb-2">
                    Клики
                  </div>
                  <div class="f-18 fw-600 mb-2">
                    17 050 шт
                  </div>
                  <div class="d-flex align-items-center color-green f-14">
                    <div class="me-1">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.3332 4L8.99984 10.3333L5.6665 7L0.666504 12" stroke="#29B147" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11.3335 4H15.3335V8" stroke="#29B147" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <span>
                                            32,1%
                                        </span>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 pr-2 pl-2 mb-3">
                <div class="border p-2 b-radius d-flex flex-column align-items-center justify-content-center">
                  <div class="f-14 color-1 mb-2">
                    Расходы
                  </div>
                  <div class="f-18 fw-600 mb-2">
                    2 144 965 ₽
                  </div>
                  <div class="d-flex align-items-center color-red f-14">
                    <div class="me-1">
                      <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.3332 12.5L8.99984 6.16667L5.6665 9.5L0.666504 4.5" stroke="#F26464" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11.3335 12.5H15.3335V8.5" stroke="#F26464" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <span>
                                            8%
                                        </span>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 pr-2 pl-2 mb-3">
                <div class="border p-2 b-radius d-flex flex-column align-items-center justify-content-center">
                  <div class="f-14 color-1 mb-2">
                    Средняя цена клика
                  </div>
                  <div class="f-18 fw-600 mb-2">
                    31 ₽
                  </div>
                  <div class="d-flex align-items-center color-green f-14">
                    <div class="me-1">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.3332 4L8.99984 10.3333L5.6665 7L0.666504 12" stroke="#29B147" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11.3335 4H15.3335V8" stroke="#29B147" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <span>
                                            3%
                                        </span>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 pr-2 pl-2 mb-3">
                <div class="border p-2 b-radius d-flex flex-column align-items-center justify-content-center">
                  <div class="f-14 color-1 mb-2">
                    Конверсии
                  </div>
                  <div class="f-18 fw-600 mb-2">
                    13,3 %
                  </div>
                  <div class="d-flex align-items-center color-red f-14">
                    <div class="me-1">
                      <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.3332 12.5L8.99984 6.16667L5.6665 9.5L0.666504 4.5" stroke="#F26464" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11.3335 12.5H15.3335V8.5" stroke="#F26464" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <span>
                                            18,79 %
                                        </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div id="chart"></div>
              </div>
            </div>
          </div>
        </div>
        <Tasks :isShowHead="false"/>
      </div>
      <div class="col-lg-6">

          <div class="warp_chat_marketolog">
            <Marketer/>
            <chat-window

                :styles="styles"
                :current-user-id="currentUserId"
                :rooms="room"
                :rooms-list-opened ="roomsListOpened"
                :rooms-loaded="roomsLoaded"
                :show-add-room="showAddRoom"
                :show-search="showSearch"
                :show-reaction-emojis="showReactionEmojis"
                :loading-rooms="loadingRooms"
                :single-room="singleRoom"
                :show-footer="true"
                :messages="messages"
                :messages-loaded="messagesLoaded"
                :text-messages="textMessages"
                :message-actions="messageActions"
                @fetch-messages="onFetchMessages"
                @send-message="sendMessage"
                @open-file ="openFile"
                @delete-message="deleteMessage"
                @edit-message="editMessage"

            />
          </div>

      </div>
    </div>
    <div class="row">
      <div class="col-12">

      </div>
    </div>
  </div>

</template>

<script>
import ChatWindow from 'vue-advanced-chat'
import 'vue-advanced-chat/dist/vue-advanced-chat.css'
import {io} from "socket.io-client";
const socket = io('http://panel.kdm1.biz/', {  path: "/api/chat" });

import Marketer from "@/views/user/component/index/Marketer"
import Tasks from "@/views/user/component/index/Tasks"

export default {
  name: "Index user",
  components: {
    ChatWindow,
    Marketer,
    Tasks
  },
  data() {
    let user =  JSON.parse(localStorage.getItem('user'));
    return{
      //chat
      styles:{
        message: {
          background: '#F1F3FA',
          backgroundMe: '#FEF5E5',
          color: '#000000',
          colorStarted: '#9ca6af',
          backgroundDeleted: '#dadfe2',
          backgroundSelected: '#c2dcf2',
          colorDeleted: '#757e85',
          colorUsername: '#9ca6af',
          colorTimestamp: '#828c94',
          backgroundDate: '#ffffff',
          colorDate: '#505a62',
          backgroundSystem: '#e5effa',
          colorSystem: '#505a62',
          backgroundMedia: 'rgba(0, 0, 0, 0.15)',
          backgroundReply: 'rgba(0, 0, 0, 0.08)',
          colorReplyUsername: '#0a0a0a',
          colorReply: '#6e6e6e',
          colorTag: '#0d579c',
          backgroundImage: '#ddd',
          colorNewMessages: '#1976d2',
          backgroundScrollCounter: '#0696c7',
          colorScrollCounter: '#fff',
          backgroundReaction: '#eee',
          borderStyleReaction: '1px solid #eee',
          backgroundReactionHover: '#fff',
          borderStyleReactionHover: '1px solid #ddd',
          colorReactionCounter: '#0a0a0a',
          backgroundReactionMe: '#cfecf5',
          borderStyleReactionMe: '1px solid #3b98b8',
          backgroundReactionHoverMe: '#cfecf5',
          borderStyleReactionHoverMe: '1px solid #3b98b8',
          colorReactionCounterMe: '#0b59b3',
          backgroundAudioRecord: '#eb4034',
          backgroundAudioLine: 'rgba(0, 0, 0, 0.15)',
          backgroundAudioProgress: '#455247',
          backgroundAudioProgressSelector: '#455247',
          colorFileExtension: '#757e85'
        },
      },
      messageActions:
          [
            {
              name: 'replyMessage',
              title: 'Ответить'
            },
            {
              name: 'editMessage',
              title: 'Отредактировать',
              onlyMe: true
            },
            {
              name: 'deleteMessage',
              title: 'Удалить сообщение',
              onlyMe: true
            },
            {
              name: 'selectMessages',
              title: 'Выбрать'
            }
          ],
      textMessages:{
        ROOMS_EMPTY: 'Чат не выбран',
        ROOM_EMPTY: 'Комната не выбрана',
        NEW_MESSAGES: 'Новое сообщение',
        MESSAGE_DELETED: 'Сообщение удалено',
        MESSAGES_EMPTY: 'Сообщений нет',
        CONVERSATION_STARTED: 'Сообщение отправлено:',
        TYPE_MESSAGE: 'Введите сообщениe',
        SEARCH: 'Поиск',
      },
      room: [],
      roomsLoaded: true,
      showSearch:true,
      roomsListOpened: false,
      showAddRoom:false,
      showReactionEmojis:false,
      singleRoom:true,
      messagesLoaded: false,
      loadingRooms: false,
      messages: [],
      currentUserId: user.id
    }
  },
  watch:{

  },
  methods: {
    //chat
    getRooms(){
      socket.on("get room", data => {
        this.room=[data];
      });
    },
    getMsg(){
      socket.on("message_m", data => {
        console.log('[line 63]',data);
        /*let tmpMessage = [...this.messages, ...data];*/
        this.messages.push(data.msg);
        //console.log('[this.messages]',this.messages);
      });
    },
    editMsg(){
      socket.on("edit_message", data => {
        console.log('[line 362]',data);
        for (let k in this.messages){
          if(this.messages[k]._id === data.msg._id){
            this.messages[k] = data.msg;
          }
        }
        /*let tmpMessage = [...this.messages, ...data];*/
        //this.messages.push(data.msg);
        console.log('[this.messages]',this.messages);
      });
    },
    loadRoom(){
      let user =  JSON.parse(localStorage.getItem('user'));
      let join ={
        is: 'user',
        rooms:{
          room: user.room,
          id: user.id,
          manager: user.manager.id
        },
      }
      //console.log('399 user',user);
      //console.log('395 line', join);
      socket.emit("subscribe", join);
    },
    onFetchMessages(data) {
      //console.log('178 line', data);


      socket.emit("get msg", data.room.roomId);

      socket.on("load msg", data => {
        setTimeout(() => {
          this.messages= data;
          this.messagesLoaded = true;
        })
      });

    },
    async sendMessage({ content, roomId, files, replyMessage }) {
      const message = {
        sender_id: this.currentUserId,
        content,
        timestamp: new Date()
      }
      if (files) {
        message.files = await this.formattedFiles(files)
      }
      let dataMsg = {
        room: roomId,
        message:message
      }
      console.log(replyMessage)
      socket.emit("message_m", dataMsg);

    },
    async formattedFiles(files) {
      const formattedFiles = []

      for (let i in files){
        let file =files[i];
        const messageFile = {
          name: file.name,
          size: file.size,
          type: file.type,
          extension: file.extension || file.type,
          url: file.url || file.localUrl
        }
        if (file.audio) {
          messageFile.audio = true
          messageFile.duration = file.duration
        }
        const blobFile = await fetch(file.localUrl).then(res => res.blob());
        console.log(blobFile);
        messageFile.b64 = await this.blobToBase64(blobFile);

        formattedFiles.push(messageFile)
      }

      return formattedFiles
    },
    async blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    },
    openFile({ file }) {
      window.open(file.file.url, '_blank')
    },
    async deleteMessage({ message, roomId }) {
      message.deleted = 1;
      console.log(roomId);
      console.log(message);

      let dataMsg = {
        room:roomId,
        message:message
      };
      socket.emit("deleted_msg", dataMsg);
      const { files } = message
      if (files) {
        files.forEach(file => {
          console.log(this.currentUserId, message._id, file);
        })
      }
    },
    async editMessage({ messageId, newContent, roomId }) {
      let dataMsg={
        messageId:messageId,
        newContent:newContent,
        room:roomId
      }
      socket.emit("edit_msg", dataMsg);
      for (let k in this.messages){
        if(this.messages[k]._id === messageId){
          this.messages[k].content = newContent;
        }
      }
    },
    //chat - end
  },
  mounted() {
    //chat
    this.loadRoom();
    this.getRooms();
    this.getMsg();
    this.editMsg();
    //chat - end
  }
};


</script>
